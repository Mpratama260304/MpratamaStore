# ============================================
# PhalaCloud Docker Compose - SQLite Version (Direct Deploy)
# MpratamaStore - Next.js E-commerce
# ============================================
# USAGE:
#   1. Copy this entire file to PhalaCloud compose editor
#   2. Update AUTH_SECRET, JWT_SECRET, and ADMIN credentials
#   3. Deploy - URL akan otomatis terdeteksi dari domain!
#
# KEY FEATURES:
#   - 100% Internal SQLite database (no external DB!)
#   - Auto migration & seed on startup
#   - Persistent data via volume mount
#   - Single container - simple deployment!
#   - AUTO-DETECT domain dari request headers (tidak perlu set URL manual!)
#   - Multi payment gateway: Stripe, PayPal, Bank Transfer
# ============================================

version: "3.9"

services:
  web:
    image: mpratamamail/mpratamastore:latest
    container_name: mpratamastore-web
    restart: unless-stopped
    
    ports:
      - "80:3000"
    
    volumes:
      # Persistent volume for SQLite database
      - mpratamastore_data:/data
    
    environment:
      # ══════════════════════════════════════════════════════════════
      # CORE SETTINGS (WAJIB)
      # ══════════════════════════════════════════════════════════════
      NODE_ENV: "production"
      PORT: "3000"
      HOSTNAME: "0.0.0.0"
      
      # ══════════════════════════════════════════════════════════════
      # DATABASE (Internal SQLite - TIDAK PERLU EXTERNAL DB!)
      # ══════════════════════════════════════════════════════════════
      DATABASE_URL: "file:/data/app.db"
      
      # ══════════════════════════════════════════════════════════════
      # APP URLs (OPSIONAL - Auto-detect dari request headers!)
      # Biarkan kosong agar app otomatis mendeteksi domain dari PhalaCloud
      # Jika ingin override manual, isi dengan domain Anda
      # ══════════════════════════════════════════════════════════════
      # NEXT_PUBLIC_APP_URL: ""
      # NEXT_PUBLIC_SITE_URL: ""
      # NEXT_PUBLIC_BASE_URL: ""
      
      # ══════════════════════════════════════════════════════════════
      # AUTHENTICATION (WAJIB)
      # Generate dengan: openssl rand -base64 32
      # ══════════════════════════════════════════════════════════════
      AUTH_SECRET: "CHANGE_ME_generate_with_openssl_rand_base64_32"
      JWT_SECRET: "CHANGE_ME_generate_with_openssl_rand_base64_32"
      
      # ══════════════════════════════════════════════════════════════
      # ADMIN USER (Untuk setup admin pertama kali)
      # ══════════════════════════════════════════════════════════════
      ADMIN_EMAIL: "admin@example.com"
      ADMIN_USERNAME: "admin"
      ADMIN_PASSWORD: "SecurePassword123!"
      
      # ══════════════════════════════════════════════════════════════
      # STRIPE PAYMENT (OPSIONAL - untuk credit card payments)
      # Dapatkan keys dari: https://dashboard.stripe.com/apikeys
      # Jika kosong, opsi Stripe tidak akan muncul di checkout
      # ══════════════════════════════════════════════════════════════
      STRIPE_SECRET_KEY: ""
      STRIPE_PUBLISHABLE_KEY: ""
      # Webhook secret untuk menerima payment notifications
      # Setup webhook di: https://dashboard.stripe.com/webhooks
      # Endpoint URL: https://YOUR-PHALA-DOMAIN/api/webhooks/stripe
      STRIPE_WEBHOOK_SECRET: ""
      
      # ══════════════════════════════════════════════════════════════
      # PAYPAL PAYMENT (OPSIONAL - untuk PayPal payments)
      # Dapatkan credentials dari: https://developer.paypal.com/
      # Jika kosong, opsi PayPal tidak akan muncul di checkout
      # Amount akan dikonversi ke USD untuk PayPal
      # ══════════════════════════════════════════════════════════════
      PAYPAL_CLIENT_ID: ""
      PAYPAL_CLIENT_SECRET: ""
      # sandbox untuk testing, live untuk production
      PAYPAL_ENV: "sandbox"
    
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 5

# Named volume for persistent SQLite database
volumes:
  mpratamastore_data:
    driver: local
